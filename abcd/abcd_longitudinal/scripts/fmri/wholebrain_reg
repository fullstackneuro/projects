#!/bin/bash


#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
#
#    3dDeconvolve Regression
#
#    Auto-generated by ScriptWriter.py
#    kiefer katovich 2012
#
#    modified by Ethan Ellis
#    December 2024
#
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# establish paths and parameters

afniproc='/mnt/acorn/ethan/afniproc'

sublist='/mnt/acorn/ethan/scripts/fmri/subs.txt'

clobber=0

if [ "$clobber" -eq 1 ]; then
	echo "clobbering old finished_reg textfile..."
	rm finished_reg.txt
	touch finished_reg.txt
fi

if ! test -f finished_reg.txt; then
	touch finished_reg.txt
fi
#-#-#-#-#-#-#-#-#-#-#-		Cycle through subjects:		-#-#-#-#-#-#-#-#-#-#-#

for subject in `cat $sublist`; do

   #extract subject info from filename
   subname='sub-'${subject:0:15}
   timepoint='ses-'${subject:16:18}


   if ! grep -Fxq $subname finished_reg.txt; then
   echo $afniproc/$subname/$timepoint

   cd $afniproc/$subname/$timepoint
   echo processing $subname

#-#-#-#-#-#-#-#-#-#-#-		Run makeVec on model file:		-#-#-#-#-#-#-#-#-#-#-#

	# vectors already made by contrastVectors.R

	#/media/lcne/afniproc/scripts/makeVec.py /media/lcne/afniproc/scripts/mid_vecs_full.txt

#-#-#-#-#-#-#-#-#-#-#-		Run waver on vectors:		-#-#-#-#-#-#-#-#-#-#-#

	waver -dt 0.8 -GAM -numout 802 -input cue.1D > cuec.1D
	waver -dt 0.8 -GAM -numout 802 -input ant.1D > antc.1D
	waver -dt 0.8 -GAM -numout 802 -input longAnt.1D > lantc.1D
	waver -dt 0.8 -GAM -numout 802 -input targ.1D > targc.1D
	waver -dt 0.8 -GAM -numout 802 -input out.1D > outc.1D
	waver -dt 0.8 -GAM -numout 802 -input gain_neut.1D > gain_neutc.1D
	waver -dt 0.8 -GAM -numout 802 -input loss_neut.1D > loss_neutc.1D
	waver -dt 0.8 -GAM -numout 802 -input gain_hit.1D > gain_hitc.1D
	waver -dt 0.8 -GAM -numout 802 -input loss_hit.1D > loss_hitc.1D

#-#-#-#-#-#-#-#-#-#-#-		Clean old regression file:		-#-#-#-#-#-#-#-#-#-#-#

	if test -f mid_reg+orig.BRIK; then
		rm -rf mid_reg+orig*
	fi

	cp -f /mnt/bacon/projects/abcd/scripts/afniproc/mid_runs.1D ./

#-#-#-#-#-#-#-#-#-#-#-		Run 3dDeconvolve:		-#-#-#-#-#-#-#-#-#-#-#

	3dDeconvolve -float -input mid_mbnf+orig -jobs 8 -concat mid_runs.1D -nfirst 0 -num_stimts 14 -polort 2 \
		-stim_file 1 '3dmotionmid.1D[1]' -stim_label 1 'roll' \
		-stim_file 2 '3dmotionmid.1D[2]' -stim_label 2 'pitch' \
		-stim_file 3 '3dmotionmid.1D[3]' -stim_label 3 'yaw' \
		-stim_file 4 '3dmotionmid.1D[4]' -stim_label 4 'dS' \
		-stim_file 5 '3dmotionmid.1D[5]' -stim_label 5 'dL' \
		-stim_file 6 '3dmotionmid.1D[6]' -stim_label 6 'dP' \
		-stim_file 7 'cuec.1D' -stim_label 7 'cue' \
		-stim_file 8 'antc.1D' -stim_label 8 'ant' \
		-stim_file 9 'lantc.1D' -stim_label 9 'lant' \
		-stim_file 10 'outc.1D' -stim_label 10 'out' \
		-stim_file 11 'gain_neutc.1D' -stim_label 11 'gain_neut' \
		-stim_file 12 'loss_neutc.1D' -stim_label 12 'loss_neut' \
		-stim_file 13 'gain_hitc.1D' -stim_label 13 'gain_hit' \
                -stim_file 14 'loss_hitc.1D' -stim_label 14 'loss_hit' \
		-tout -fout -bucket mid_reg

#-#-#-#-#-#-#-#-#-#-#-		Write zscored dataset:		-#-#-#-#-#-#-#-#-#-#-#

	if test -f zmid_reg+orig.BRIK; then
		rm -rf zmid_reg+orig*
	fi

	3dmerge -doall -1zscore -prefix zmid_reg mid_reg+orig

#-#-#-#-#-#-#-#-#-#-#-		Remove non-zscored dataset:		-#-#-#-#-#-#-#-#-#-#-#

	#rm -rf mid_reg+orig*
	echo $subname >> finished_reg.txt
   fi
done
